'use strict';

/**
 * Exports NumberSelect constructor
 *
 * @module number-select-class
 */

/**
 * Generic number adder and remover
 *
 * @constructor
 * @param {object} specs
 * @param {string} specs.id
 * @param {number} specs.number
 * @param {number} specs.min
 * @param {number} specs.max
 * @param {object} announcer - [Announcer]{@link
 *   module:announcer-class~Announcer} instance, handles communication between
 *   objects
 */
var NumberSelect = function(specs, announcer){
  this.number = parseInt(specs.number, 10);
  this.id = specs.id;
  this.min = specs.min;
  this.max = specs.max;

  this.containerElement = document.createElement('div');
  this.containerElement.classList.add('number-select');
  this.containerElement.addEventListener('animationend', function(){
    this.classList.remove('number-select-pulsate');
  });

  this.addElement = document.createElement('span');
  this.addElement.classList.add('number-select-add');
  this.addElement.textContent = '+';

  this.numberElement = document.createElement('span');
  this.numberElement.classList.add('number-select-number');
  this.numberElement.textContent = this.number;

  this.subtractElement = document.createElement('span');
  this.subtractElement.classList.add('number-select-subtract');
  this.subtractElement.textContent = '-';

  this.containerElement.appendChild(this.addElement);
  this.containerElement.appendChild(this.numberElement);
  this.containerElement.appendChild(this.subtractElement);

  this.addElement.addEventListener('click', this.addOne.bind(this));
  this.subtractElement.addEventListener('click', this.subtractOne.bind(this));

  this.announcer = announcer;
  this.announcer.publish(this.publish());
};

/**
 * Number setter without escaping min and max
 * @param {number} number - New number to set
 */
NumberSelect.prototype.setNumber = function(number){
  var proposedNumber = this.getConstrainedNumber(number);
  if(proposedNumber.wasOutOfBounds){
    this.pulsate();
  }
  this.number = proposedNumber.number;
  this.update();
};

/**
 * Increase number by one
 */
NumberSelect.prototype.addOne = function(){
  this.setNumber(this.number + 1);
};

/**
 * Decrease number by one
 */
NumberSelect.prototype.subtractOne = function(){
  this.setNumber(this.number - 1);
};

/**
 * Get a number within the bounds of min and max
 *
 * @param {number} number
 * @returns {object} with keys number and wasOutOfBounds
 */
NumberSelect.prototype.getConstrainedNumber = function(number){
  var newNumber = number;
  var wasOutOfBounds = false;
  if(newNumber > this.max){
    newNumber = this.max;
    wasOutOfBounds = true;
  }
  else if(newNumber < this.min){
    newNumber = this.min;
    wasOutOfBounds = true;
  }
  return {number: newNumber, wasOutOfBounds: wasOutOfBounds};
};

/**
 * Visually represent that something is not working
 */
NumberSelect.prototype.pulsate = function(){
  this.containerElement.classList.add('number-select-pulsate');
};

/**
 * Number getter
 *
 * @returns {number} number
 */
NumberSelect.prototype.getNumber = function(){
  return this.number;
};

/**
 * Max getter
 *
 * @returns {number} max
 */
NumberSelect.prototype.getMax = function(){
  return this.max;
};

/**
 * Min getter
 *
 * @returns {number} min
 */
NumberSelect.prototype.getMin = function(){
  return this.min;
};

/**
 * Returns object used by Announcer to subscribe and/or update objects
 *
 * @returns {module:announcer-class~publishData}
 */
NumberSelect.prototype.publish = function(){
  return {
    category: 'number',
    id: this.id,
    data: this.getNumber()
  };
};

/**
 * Render number elements to the DOM
 *
 * @param {Element} targetElement - Element to which append
 * @returns {object} returns `this` for chaining
 */
NumberSelect.prototype.render = function(targetElement){
  targetElement.appendChild(this.containerElement);
  return this;
};

/**
 * Update DOM with current number
 */
NumberSelect.prototype.update = function(){
  this.announcer.publish(this.publish());
  this.numberElement.textContent = this.number;
};


module.exports = NumberSelect;
