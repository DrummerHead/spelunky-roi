'use strict';

var _ = require('lodash');

var Announcer = function(){
  this.data = {};
};

Announcer.prototype.findData = function(category, id){
  return _.find(this.data[category], function(previous){
    return previous.id === id;
  });
};

Announcer.prototype.publish = function(me){
  if(!this.data.hasOwnProperty(me.category)){
    this.data[me.category] = [];
  }

  var previousData = this.findData(me.category, me.id);

  if(previousData){
    _.assign(previousData, me);
  }
  else {
    this.data[me.category].push(me);
  }

  this.announcements(me);

};

Announcer.prototype.announcements = function(subject){
  if(subject.category === 'number'){
    var i, l, newPrice;
    var area = this.findData('number', 'area') || {data: 1};
    var level = this.findData('number', 'level') || {data: 1};

    for(i = 0, l = this.data.consumable.length; i < l; i++){
      newPrice = this.data.consumable[i].data.updatePrice(area.data, level.data);
      this.data.accountant[0].data.updatePrice(
        {
          category: 'investments',
          id: this.data.consumable[i].data.name,
          number: newPrice
        }
      );
    }
    if(subject.id === 'area'){
      for(i = 0, l = this.data.treasure.length; i < l; i++){
        newPrice = this.data.treasure[i].data.updatePrice(area.data);
        this.data.accountant[0].data.updatePrice(
          {
            category: 'profits',
            id: this.data.treasure[i].data.name,
            number: newPrice
          }
        );
      }
    }
  }
};

Announcer.prototype.invest = function(data){
  this.data.accountant[0].data.invest(data);
};

Announcer.prototype.profit = function(data){
  this.data.accountant[0].data.profit(data);
};


module.exports = Announcer;
